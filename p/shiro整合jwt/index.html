<!DOCTYPE html>
<html lang="zh-cn">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='记录项目中JWT身份认证'><title>shiro整合JWT</title>

<link rel='canonical' href='https://lbqaq.top/p/shiro%E6%95%B4%E5%90%88jwt/'>

<link rel="stylesheet" href="/scss/style.min.css"><meta property='og:title' content='shiro整合JWT'>
<meta property='og:description' content='记录项目中JWT身份认证'>
<meta property='og:url' content='https://lbqaq.top/p/shiro%E6%95%B4%E5%90%88jwt/'>
<meta property='og:site_name' content='luoboQAQ'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='JWT' /><meta property='article:tag' content='Shiro' /><meta property='article:published_time' content='2021-10-08T15:19:44&#43;08:00'/><meta property='article:modified_time' content='2021-10-09T11:30:00&#43;08:00'/><meta property='og:image' content='https://lbqaq.top/p/shiro%E6%95%B4%E5%90%88jwt/92388693.webp' />
<meta name="twitter:title" content="shiro整合JWT">
<meta name="twitter:description" content="记录项目中JWT身份认证"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://lbqaq.top/p/shiro%E6%95%B4%E5%90%88jwt/92388693.webp' /><script async defer data-website-id="5a23d952-27c7-4abd-b8f0-c69397b25b55" src="https://umami.lbqaq.top/umami.js"></script>
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://lbqaq.top" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>返回</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/shiro%E6%95%B4%E5%90%88jwt/">
                <img src="/p/shiro%E6%95%B4%E5%90%88jwt/92388693.webp"
                        
                        width="3013" 
                        height="1416" 
                        loading="lazy"
                        alt="Featured image of post shiro整合JWT" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="/p/shiro%E6%95%B4%E5%90%88jwt/">shiro整合JWT</a>
    </h2>

    
    <h3 class="article-subtitle">
        记录项目中JWT身份认证
    </h3>
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 08, 2021</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 4 分钟
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <p>在我现在在做的项目中需要进行身份和权限认证，在网上找了些教程，推荐都是使用JWT来进行身份认证，于是便决定使用此方法来实现。<del>（然而用完了才发现JWT也有缺点）</del></p>
<h2 id="何为jwt">何为JWT</h2>
<p>所谓JWT，全称是JSON Web Token。下面是从<a class="link" href="https://jwt.io"  target="_blank" rel="noopener"
    >官网</a>摘抄的定义：</p>
<blockquote>
<p>JWT是一个开放的标准（RFC 7519），它定义了一种紧凑和独立的方式，以JSON对象的形式在各方之间安全地传输信息。这种信息可以被验证和信任，因为它是经过数字签名的。JWTs可以使用秘密（使用HMAC算法）或使用RSA或ECDSA的公共/私人密钥对进行签名。</p>
</blockquote>
<p>按我的理解，JWT其实就是将传统的session认证中的token存储位置从服务器上下发给用户，服务器只需要判断传来的token是否合法而无需存储。这样做的好处就是可以做分布式的服务器，无需考虑用户是在哪一台服务器上登录的。</p>
<p>详细的定义和构成我这里就不展开了，这里主要关注JWT中Payload（载荷）。这是有效信息存放的地方，我们一般关注这里就行了。</p>
<p>下面是官方提供且建议（并不强制）使用的声明：</p>
<ul>
<li>
<p><strong>iss</strong>: jwt签发者</p>
</li>
<li>
<p><strong>sub</strong>: 主题</p>
</li>
<li>
<p><strong>aud</strong>: 接收jwt的一方</p>
</li>
<li>
<p><strong>exp</strong>: jwt的过期时间，这个过期时间必须要大于签发时间</p>
</li>
<li>
<p><strong>nbf</strong>: 生效时间，在此时间之前该jwt都是不可用的.</p>
</li>
<li>
<p><strong>iat</strong>: jwt的签发时间</p>
</li>
<li>
<p><strong>jti</strong>: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</p>
</li>
</ul>
<p>当然，在载荷中还可以存放自定义的信息，在本项目中使用官方提供的就足以了，故不展开。</p>
<h2 id="认证流程">认证流程</h2>
<ul>
<li>用户使用用户名密码来请求服务器</li>
<li>服务器进行验证用户的信息</li>
<li>服务器通过验证发送给用户一个token</li>
<li>客户端存储token，并在每次请求时附送上这个token值</li>
<li>服务端验证token值，并返回数据</li>
</ul>
<h2 id="具体实现">具体实现</h2>
<h3 id="导入依赖包">导入依赖包</h3>
<p>第一步当然是导入相关依赖了，使用Maven进行包管理。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- shiro --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>shiro-spring<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.8.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- jwt --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.auth0<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>java-jwt<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.18.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div><h3 id="封装jwt工具类">封装JWT工具类</h3>
<p>这里主要实现JWT的生成、验证、提取用户名三个功能</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtUtil</span> <span class="o">{</span>
    <span class="cm">/**
</span><span class="cm">     * 服务器私钥
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Algorithm</span> <span class="n">ALGORITHM</span> <span class="o">=</span> <span class="n">Algorithm</span><span class="o">.</span><span class="na">HMAC256</span><span class="o">(</span><span class="s">&#34;test&#34;</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 生成JSON Web Token
</span><span class="cm">     *
</span><span class="cm">     * @param username  用户名
</span><span class="cm">     * @param issuer    签发者
</span><span class="cm">     * @param subject   面向主体
</span><span class="cm">     * @param ttlMillis 生效时长(单位:毫秒)
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">creatJwt</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">issuer</span><span class="o">,</span> <span class="n">String</span> <span class="n">subject</span><span class="o">,</span> <span class="kt">long</span> <span class="n">ttlMillis</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">nowMillis</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">Date</span> <span class="n">now</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">nowMillis</span><span class="o">);</span>

        <span class="n">JWTCreator</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">JWT</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withAudience</span><span class="o">(</span><span class="n">username</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withIssuedAt</span><span class="o">(</span><span class="n">now</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withSubject</span><span class="o">(</span><span class="n">subject</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withIssuer</span><span class="o">(</span><span class="n">issuer</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">ttlMillis</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">expMillis</span> <span class="o">=</span> <span class="n">nowMillis</span> <span class="o">+</span> <span class="n">ttlMillis</span><span class="o">;</span>
            <span class="n">Date</span> <span class="n">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">expMillis</span><span class="o">);</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">withExpiresAt</span><span class="o">(</span><span class="n">exp</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">sign</span><span class="o">(</span><span class="n">ALGORITHM</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 获取签发对象
</span><span class="cm">     *
</span><span class="cm">     * @param token 需要解密的token
</span><span class="cm">     * @return 解密后获得的对象，失败返回null
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getAudience</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">audience</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">audience</span> <span class="o">=</span> <span class="n">JWT</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">token</span><span class="o">).</span><span class="na">getAudience</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JWTDecodeException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;输入的token无法解析&#34;</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">audience</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 验证token是否正确
</span><span class="cm">     *
</span><span class="cm">     * @param token 需要验证的token
</span><span class="cm">     * @return 是否通过验证
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Boolean</span> <span class="nf">verifyToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">JWTVerifier</span> <span class="n">verifier</span> <span class="o">=</span> <span class="n">JWT</span><span class="o">.</span><span class="na">require</span><span class="o">(</span><span class="n">ALGORITHM</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
            <span class="n">verifier</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JWTVerificationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="配置shiro">配置Shiro</h3>
<p>这里的<code>ShiroConfig.java</code>与一般Shiro项目的配置有以下几点不同：</p>
<ul>
<li>禁用Session</li>
<li>使用自定义的jwtFilter过滤器，用来拦截并处理携带JWT token的请求</li>
<li>使用自定义的Realm认证器，用于验证用户是否存在及查询用户权限</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShiroConfig</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">MyRealm</span> <span class="n">myRealm</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">DefaultWebSecurityManager</span> <span class="nf">getDefaultWebSecurityManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">DefaultWebSecurityManager</span> <span class="n">manger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultWebSecurityManager</span><span class="o">();</span>
        <span class="n">manger</span><span class="o">.</span><span class="na">setRealm</span><span class="o">(</span><span class="n">myRealm</span><span class="o">);</span>
        <span class="c1">// 关闭shiro自带的session
</span><span class="c1"></span>        <span class="n">DefaultSubjectDAO</span> <span class="n">subjectDAO</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultSubjectDAO</span><span class="o">();</span>
        <span class="n">subjectDAO</span><span class="o">.</span><span class="na">setSessionStorageEvaluator</span><span class="o">(</span><span class="n">sessionStorageEvaluator</span><span class="o">());</span>
        <span class="n">manger</span><span class="o">.</span><span class="na">setSubjectDAO</span><span class="o">(</span><span class="n">subjectDAO</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">manger</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">ShiroFilterFactoryBean</span> <span class="nf">getShiroFilterFactoryBean</span><span class="o">(</span><span class="n">DefaultWebSecurityManager</span> <span class="n">manger</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ShiroFilterFactoryBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CustomShiroFilterFactoryBean</span><span class="o">();</span>
        <span class="n">bean</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">manger</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Filter</span><span class="o">&gt;</span> <span class="n">filterMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">filterMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;jwt&#34;</span><span class="o">,</span> <span class="n">getJwtFilter</span><span class="o">());</span>
        <span class="n">bean</span><span class="o">.</span><span class="na">setFilters</span><span class="o">(</span><span class="n">filterMap</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashMap</span><span class="o">&lt;&gt;();</span>
        <span class="c1">//设置过滤规则，anon表示无需认证，其余的请求都通过自定义的jwt认证器
</span><span class="c1"></span>        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">,</span> <span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/swagger-ui/**&#34;</span><span class="o">,</span> <span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/v3/api-docs&#34;</span><span class="o">,</span> <span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/swagger-resources/**&#34;</span><span class="o">,</span> <span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/unauthorized/**&#34;</span><span class="o">,</span> <span class="s">&#34;anon&#34;</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;/**&#34;</span><span class="o">,</span> <span class="s">&#34;jwt&#34;</span><span class="o">);</span>
        <span class="n">bean</span><span class="o">.</span><span class="na">setFilterChainDefinitionMap</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="n">bean</span><span class="o">.</span><span class="na">setLoginUrl</span><span class="o">(</span><span class="s">&#34;/login&#34;</span><span class="o">);</span>
        <span class="c1">// 设置无权限时跳转的 url
</span><span class="c1"></span>        <span class="n">bean</span><span class="o">.</span><span class="na">setUnauthorizedUrl</span><span class="o">(</span><span class="s">&#34;/unauthorized/无权限&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="n">JwtFilter</span> <span class="nf">getJwtFilter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">JwtFilter</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 开启注解代理
</span><span class="cm">     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">AuthorizationAttributeSourceAdvisor</span> <span class="nf">authorizationAttributeSourceAdvisor</span><span class="o">(</span><span class="n">SecurityManager</span> <span class="n">securityManager</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">AuthorizationAttributeSourceAdvisor</span> <span class="n">authorizationAttributeSourceAdvisor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthorizationAttributeSourceAdvisor</span><span class="o">();</span>
        <span class="n">authorizationAttributeSourceAdvisor</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">securityManager</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">authorizationAttributeSourceAdvisor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 禁用session, 不保存用户登录状态。保证每次请求都重新认证
</span><span class="cm">     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">protected</span> <span class="n">SessionStorageEvaluator</span> <span class="nf">sessionStorageEvaluator</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">DefaultSessionStorageEvaluator</span> <span class="n">sessionStorageEvaluator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultSessionStorageEvaluator</span><span class="o">();</span>
        <span class="n">sessionStorageEvaluator</span><span class="o">.</span><span class="na">setSessionStorageEnabled</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">sessionStorageEvaluator</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="自定义token">自定义Token</h3>
<p>由于使用了JWT当token，自然要写自定义的Token</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtToken</span> <span class="kd">implements</span> <span class="n">AuthenticationToken</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">token</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">JwtToken</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getPrincipal</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">token</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getCredentials</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">token</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="自定义过滤器">自定义过滤器</h3>
<p>由于使用了JWT，所以不能使用shiro中自带的过滤器，而是自定义自己的过滤器 <code>JWTFilter</code>，<code>JWTFilter</code> 继承了 <code>BasicHttpAuthenticationFilter</code>，并部分原方法进行了重写</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JwtFilter</span> <span class="kd">extends</span> <span class="n">BasicHttpAuthenticationFilter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isAccessAllowed</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">mappedValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//判断请求的请求头是否带上 &#34;Token&#34;
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">isLoginAttempt</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">//如果存在，则进入 executeLogin 方法执行登入，检查 token 是否正确
</span><span class="c1"></span>            <span class="k">try</span> <span class="o">{</span>
                <span class="n">executeLogin</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//token 错误
</span><span class="c1"></span>                <span class="n">responseError</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//如果请求头不存在 Token，则可能是执行登陆操作或者是游客状态访问，无需检查 token，直接返回 true
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
</span><span class="cm">     * 判断用户是否想要登入。
</span><span class="cm">     * 检测 header 里面是否包含 Token 字段
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isLoginAttempt</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">HttpServletRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&#34;Token&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">executeLogin</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">HttpServletRequest</span> <span class="n">httpServletRequest</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&#34;Token&#34;</span><span class="o">);</span>
        <span class="n">JwtToken</span> <span class="n">jwtToken</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JwtToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="c1">// 提交给realm进行登入，如果错误他会抛出异常并被捕获
</span><span class="c1"></span>        <span class="n">getSubject</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">).</span><span class="na">login</span><span class="o">(</span><span class="n">jwtToken</span><span class="o">);</span>
        <span class="c1">// 如果没有抛出异常则代表登入成功，返回true
</span><span class="c1"></span>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 将非法请求跳转到 /unauthorized/**
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">responseError</span><span class="o">(</span><span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">HttpServletResponse</span> <span class="n">httpServletResponse</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
            <span class="c1">//设置编码，否则中文字符在重定向时会变为空字符串
</span><span class="c1"></span>            <span class="n">message</span> <span class="o">=</span> <span class="n">URLEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>
            <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="s">&#34;/unauthorized/&#34;</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>该过滤器有这几大步骤：</p>
<ol>
<li>检验请求头是否带有Token</li>
<li>如果带有 token，执行 shiro 的 login() 方法，将 token 提交到 Realm 中进行检验；如果没有 token，说明当前状态为游客状态（或者其他一些不需要进行认证的接口）</li>
<li>如果在 token 校验的过程中出现错误，如 token 校验失败，那么我会将该请求视为认证不通过，则重定向到 <code>/unauthorized/**</code></li>
</ol>
<h3 id="自定义realm">自定义Realm</h3>
<p>这里主要是进行身份认证和权限认证</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyRealm</span> <span class="kd">extends</span> <span class="n">AuthorizingRealm</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">RoleService</span> <span class="n">roleService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="n">PermissionService</span> <span class="n">permissionService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">token</span> <span class="k">instanceof</span> <span class="n">JwtToken</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 权限认证
</span><span class="cm">     * 只有当需要检测用户权限的时候才会调用此方法，例如checkRole,checkPermission之类的
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="n">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">principals</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">next</span><span class="o">();</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">roles</span> <span class="o">=</span> <span class="n">roleService</span><span class="o">.</span><span class="na">getAllRoleByUserName</span><span class="o">(</span><span class="n">userName</span><span class="o">);</span>
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">permissions</span> <span class="o">=</span> <span class="n">permissionService</span><span class="o">.</span><span class="na">getAllPermissionByUserName</span><span class="o">(</span><span class="n">userName</span><span class="o">);</span>
        <span class="n">SimpleAuthorizationInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleAuthorizationInfo</span><span class="o">();</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setRoles</span><span class="o">(</span><span class="n">roles</span><span class="o">);</span>
        <span class="n">info</span><span class="o">.</span><span class="na">setStringPermissions</span><span class="o">(</span><span class="n">permissions</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 身份认证
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="n">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
        <span class="n">JwtToken</span> <span class="n">jwtToken</span> <span class="o">=</span> <span class="o">(</span><span class="n">JwtToken</span><span class="o">)</span> <span class="n">token</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">jwtTokenPrincipal</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">jwtToken</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">JwtUtil</span><span class="o">.</span><span class="na">getAudience</span><span class="o">(</span><span class="n">jwtTokenPrincipal</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userName</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">JwtUtil</span><span class="o">.</span><span class="na">verifyToken</span><span class="o">(</span><span class="n">jwtTokenPrincipal</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">AuthenticationException</span><span class="o">(</span><span class="s">&#34;token认证失败！&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">getUserByUserName</span><span class="o">(</span><span class="n">userName</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">AuthenticationException</span><span class="o">(</span><span class="s">&#34;该用户不存在！&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span> <span class="n">jwtTokenPrincipal</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getRealName</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="异常处理">异常处理</h3>
<p>第一个是专门处理身份认证时的异常</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@ApiOperation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;接收未授权错误&#34;</span><span class="o">,</span> <span class="n">notes</span> <span class="o">=</span> <span class="s">&#34;返回错误信息&#34;</span><span class="o">)</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/unauthorized/{message}&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">Result</span> <span class="nf">unauthorized</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Result</span><span class="o">().</span><span class="na">setCode</span><span class="o">(</span><span class="n">233</span><span class="o">).</span><span class="na">setMessage</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>第二个则是全局接管Shiro的异常，在其中进行处理</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="nd">@RestControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExceptionController</span> <span class="o">{</span>
    <span class="cm">/**
</span><span class="cm">     * 捕捉shiro的异常
</span><span class="cm">     */</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">ShiroException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">handle401</span><span class="o">(</span><span class="n">ShiroException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Result</span><span class="o">();</span>
        <span class="n">result</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">666</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">UnauthenticatedException</span><span class="o">){</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="s">&#34;您没有登录！&#34;</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">UnauthorizedException</span><span class="o">){</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="s">&#34;您没有权限访问！&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="解决中文报错">解决中文报错</h3>
<p>在Shiro1.7版本之后增加了url校验，如果有中文字符就不通过。然而我们项目里返回错误信息就是通过url来实现的。参考<a class="link" href="https://blog.csdn.net/qq_35598240/article/details/110310638"  target="_blank" rel="noopener"
    >这篇文章</a>知道，需要自己重写<code>ShiroFilterFactoryBean</code>来实现关闭url校验</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomShiroFilterFactoryBean</span> <span class="kd">extends</span> <span class="n">ShiroFilterFactoryBean</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">FilterChainManager</span> <span class="nf">createFilterChainManager</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">FilterChainManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">createFilterChainManager</span><span class="o">();</span>
        <span class="c1">// URL携带中文400，servletPath中文校验bug
</span><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Filter</span><span class="o">&gt;</span> <span class="n">filterMap</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">getFilters</span><span class="o">();</span>
        <span class="n">Filter</span> <span class="n">invalidRequestFilter</span> <span class="o">=</span> <span class="n">filterMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DefaultFilter</span><span class="o">.</span><span class="na">invalidRequest</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">invalidRequestFilter</span> <span class="k">instanceof</span> <span class="n">InvalidRequestFilter</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">((</span><span class="n">InvalidRequestFilter</span><span class="o">)</span> <span class="n">invalidRequestFilter</span><span class="o">).</span><span class="na">setBlockNonAscii</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">manager</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h3 id="开始使用">开始使用</h3>
<ul>
<li>
<p>身份认证在Controller上添加<code>@RequiresRoles(&quot;xxx&quot;)</code></p>
</li>
<li>
<p>权限认证在Controller上添加<code>@RequiresPermissions(&quot;xxx&quot;)</code></p>
</li>
</ul>
<h2 id="测试">测试</h2>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 125; 
			flex-basis: 300px"
	>
	<a href="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009111928223.png" data-size="423x338">
		<img src="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009111928223.png"
			width="423"
			height="338"
			srcset="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009111928223_hu2e6972bb45cced2d2c48b321e1bd5119_23141_480x0_resize_box_3.png 480w, /p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009111928223_hu2e6972bb45cced2d2c48b321e1bd5119_23141_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="游客访问，不带Token">
	</a>
	
	<figcaption>游客访问，不带Token</figcaption>
	
</figure></p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 117; 
			flex-basis: 282px"
	>
	<a href="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112720855.png" data-size="412x350">
		<img src="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112720855.png"
			width="412"
			height="350"
			srcset="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112720855_hue95c7edd6c8f227bd7a2307daccfac46_22741_480x0_resize_box_3.png 480w, /p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112720855_hue95c7edd6c8f227bd7a2307daccfac46_22741_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="不带token访问">
	</a>
	
	<figcaption>不带token访问</figcaption>
	
</figure></p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 136; 
			flex-basis: 327px"
	>
	<a href="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112759761.png" data-size="471x345">
		<img src="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112759761.png"
			width="471"
			height="345"
			srcset="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112759761_hu622c0b772e30d3302e556b3d840cdcfb_24337_480x0_resize_box_3.png 480w, /p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112759761_hu622c0b772e30d3302e556b3d840cdcfb_24337_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="带上token">
	</a>
	
	<figcaption>带上token</figcaption>
	
</figure></p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 127; 
			flex-basis: 307px"
	>
	<a href="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112832784.png" data-size="421x329">
		<img src="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112832784.png"
			width="421"
			height="329"
			srcset="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112832784_huaff16ef37207e07efb49e3844b19d782_24155_480x0_resize_box_3.png 480w, /p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112832784_huaff16ef37207e07efb49e3844b19d782_24155_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="带上错误的token">
	</a>
	
	<figcaption>带上错误的token</figcaption>
	
</figure></p>
<p><figure 
	
		class="gallery-image" 
		style="
			flex-grow: 126; 
			flex-basis: 304px"
	>
	<a href="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112929544.png" data-size="427x337">
		<img src="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112929544.png"
			width="427"
			height="337"
			srcset="/p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112929544_hu0da4768b5bb638d8c7548b036fc86b2d_24210_480x0_resize_box_3.png 480w, /p/shiro%E6%95%B4%E5%90%88jwt/IMAGE/image-20211009112929544_hu0da4768b5bb638d8c7548b036fc86b2d_24210_1024x0_resize_box_3.png 1024w"
			loading="lazy"
			alt="访问无权限的接口">
	</a>
	
	<figcaption>访问无权限的接口</figcaption>
	
</figure></p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a class="link" href="https://www.jianshu.com/p/3c51832f1051"  target="_blank" rel="noopener"
    >教你 Shiro + SpringBoot 整合 JWT</a></li>
<li><a class="link" href="https://blog.csdn.net/pengjunlee/article/details/95600843"  target="_blank" rel="noopener"
    >Shiro步步为营&ndash;如何优雅地与JWT集成</a></li>
</ul>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/jwt/">JWT</a>
        
            <a href="/tags/shiro/">Shiro</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            最后更新于 Oct 09, 2021 11:30 &#43;0800
        </span>
    </section></footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
</aside>

     
     
        
    <script src='//cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js'></script>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
    .waline-container .vcount {
        color: var(--card-text-color-main);
    }
</style><script>
    
    new Waline({"avatar":"mp","dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],"lang":"zh-CN","locale":{"admin":"Admin"},"requiredMeta":["name","email","url"],"serverURL":"https://waline.lbqaq.top/"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2021 luoboQAQ
    </section>
    
    <section class="powerby">
        
            <a href="https://umami.lbqaq.top/share/gbMqUqkF/Blog">访问统计</a><br/><a href="https://beian.miit.gov.cn">苏ICP备2021037116号</a> <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.2.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">目录</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#何为jwt">何为JWT</a></li>
    <li><a href="#认证流程">认证流程</a></li>
    <li><a href="#具体实现">具体实现</a>
      <ol>
        <li><a href="#导入依赖包">导入依赖包</a></li>
        <li><a href="#封装jwt工具类">封装JWT工具类</a></li>
        <li><a href="#配置shiro">配置Shiro</a></li>
        <li><a href="#自定义token">自定义Token</a></li>
        <li><a href="#自定义过滤器">自定义过滤器</a></li>
        <li><a href="#自定义realm">自定义Realm</a></li>
        <li><a href="#异常处理">异常处理</a></li>
        <li><a href="#解决中文报错">解决中文报错</a></li>
        <li><a href="#开始使用">开始使用</a></li>
      </ol>
    </li>
    <li><a href="#测试">测试</a></li>
    <li><a href="#参考文章">参考文章</a></li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
